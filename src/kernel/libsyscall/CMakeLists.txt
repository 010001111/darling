project(libsyscall)

cmake_minimum_required(VERSION 2.4.0)

enable_language(C ASM)

set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -std=c99 -nostdinc")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}/wrappers")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}/mach")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}/../iokit")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}/os")
include_directories("${DARLING_TOP_DIRECTORY}/platform-include")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}/../../libc/include")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}/../../duct/include")
include_directories("${CMAKE_CURRENT_BINARY_DIR}")
add_definitions(-DPRIVATE -D__DARWIN_C_LEVEL=20150101)
add_definitions('-D__XNU_PRIVATE_EXTERN=')
#add_definitions(-DKERNEL)

set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -nostdlib -Wl,--version-script=${DARLING_TOP_DIRECTORY}/darwin.map")

set(MIG_USER_HEADER_SUFFIX "_internal.h")
mig(mach/exc.defs)
mig(mach/host_priv.defs)
mig(mach/host_security.defs)
mig(mach/ledger.defs)
mig(mach/lock_set.defs)
mig(mach/mach_host.defs)
mig(mach/mach_port.defs)
mig(mach/mach_vm.defs)
mig(mach/mach_voucher.defs)
mig(mach/notify.defs)
mig(mach/processor_set.defs)
mig(mach/processor.defs)
mig(mach/task.defs)
mig(mach/thread_act.defs)
mig(mach/vm_map.defs)

set(syscall_sources
	#wrappers/coalition.c
	# wrappers/__commpage_gettimeofday.c
	#wrappers/csr.c
	wrappers/gethostuuid.c
	wrappers/getiopolicy_np.c
	#wrappers/guarded_open_dprotected_np.c
	#wrappers/guarded_open_np.c
	wrappers/init_cpu_capabilities.c
	wrappers/ioctl.c
	wrappers/_libc_funcptr.c
	wrappers/_libkernel_init.c
	wrappers/mach_approximate_time.c
	wrappers/open_dprotected_np.c
	wrappers/posix_sem_obsolete.c
	wrappers/remove-counter.c
	wrappers/renameat.c
	wrappers/rename.c
	wrappers/rename_ext.c
	wrappers/rmdir.c
	#wrappers/select-base.c
	wrappers/setpriority.c
	#wrappers/sfi.c
	#wrappers/sigsuspend-base.c
	wrappers/unlinkat.c
	wrappers/unlink.c
	wrappers/kill.c
	
	wrappers/cancelable/fcntl.c
	wrappers/cancelable/fcntl-cancel.c
	#wrappers/cancelable/select.c # defined in sys/
	#wrappers/cancelable/select-cancel.c
	wrappers/cancelable/sigsuspend.c
	wrappers/cancelable/sigsuspend-cancel.c
	
	wrappers/unix03/chmod.c
	wrappers/unix03/fchmod.c
	wrappers/unix03/getrlimit.c
	wrappers/unix03/mmap.c
	wrappers/unix03/munmap.c
	wrappers/unix03/setrlimit.c
	
	#wrappers/legacy/accept.c
	#wrappers/legacy/bind.c
	#wrappers/legacy/connect.c
	#wrappers/legacy/getattrlist.c
	#wrappers/legacy/getaudit.c
	#wrappers/legacy/getpeername.c
	#wrappers/legacy/getsockname.c
	#wrappers/legacy/kill.c
	#wrappers/legacy/lchown.c
	#wrappers/legacy/listen.c
	#wrappers/legacy/mprotect.c
	#wrappers/legacy/msync.c
	#wrappers/legacy/munmap.c
	#wrappers/legacy/open.c
	#wrappers/legacy/recvfrom.c
	#wrappers/legacy/recvmsg.c
	#wrappers/legacy/select.c
	#wrappers/legacy/select-pre1050.c
	#wrappers/legacy/sendmsg.c
	#wrappers/legacy/sendto.c
	#wrappers/legacy/setattrlist.c
	#wrappers/legacy/sigsuspend.c
	#wrappers/legacy/socketpair.c

	custom/errno.c
	
	# MIG generated files
	${CMAKE_CURRENT_BINARY_DIR}/mach/excUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/host_privUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/host_securityUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/ledgerUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/lock_setUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/mach_hostUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/mach_portUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/mach_vmUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/mach_voucherUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/notifyUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/processor_setUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/processorUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/taskUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/thread_actUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/vm_mapUser.c
	${CMAKE_CURRENT_BINARY_DIR}/mach/clockUser.c
	
	mach/mach_init.c
	mach/clock_sleep.c
	mach/dylib_link.c
	mach/error_codes.c
	mach/exc_catcher.c
	mach/exc_catcher_state.c
	mach/exc_catcher_state_identity.c
	mach/fprintf_stderr.c
	mach/mach_error.c
	mach/mach_error_string.c
	mach/mach_init.c
	mach/mach_legacy.c
	mach/mach_msg.c
	mach/mach_port.c
	mach/mach_vm.c
	mach/mig_allocate.c
	mach/mig_deallocate.c
	mach/mig_reply_port.c
	mach/mig_reply_setup.c
	mach/mig_strncpy.c
	mach/ms_thread_switch.c
	mach/panic.c
	mach/port_obj.c
	mach/semaphore.c
	mach/slot_name.c
	mach/string.c
	mach/thread_act.c

	sys/__accept_nocancel.S
	sys/__accept.S
	sys/__access_extended.S
	sys/access.S
	sys/acct.S
	sys/adjtime.S
	sys/aio_cancel.S
	sys/aio_error.S
	sys/aio_fsync.S
	sys/aio_read.S
	sys/aio_return.S
	sys/__aio_suspend_nocancel.S
	sys/aio_suspend.S
	sys/aio_write.S
	sys/auditctl.S
	sys/auditon.S
	sys/audit.S
	sys/audit_session_join.S
	sys/audit_session_port.S
	sys/audit_session_self.S
	sys/__bind.S
	sys/__bsdthread_create.S
	sys/__bsdthread_ctl.S
	sys/__bsdthread_register.S
	sys/__bsdthread_terminate.S
	sys/change_fdguard_np.S
	sys/chdir.S
	sys/chflags.S
	sys/__chmod_extended.S
	sys/__chmod.S
	sys/chown.S
	sys/chroot.S
	sys/__chud.S
	sys/__close_nocancel.S
	sys/close.S
	sys/__coalition_info.S
	sys/__coalition.S
	sys/__connect_nocancel.S
	sys/__connect.S
	sys/connectx.S
	sys/__copyfile.S
	sys/csops_audittoken.S
	sys/csops.S
	sys/__csrctl.S
	sys/custom.S
	sys/__delete.S
	sys/__disable_threadsignal.S
	sys/disconnectx.S
	sys/dup2.S
	sys/dup.S
	sys/exchangedata.S
	sys/execve.S
	sys/__exit.S
	sys/faccessat.S
	sys/fchdir.S
	sys/fchflags.S
	sys/fchmodat.S
	sys/__fchmod_extended.S
	sys/__fchmod.S
	sys/fchownat.S
	sys/fchown.S
	sys/__fcntl_nocancel.S
	sys/__fcntl.S
	sys/fdatasync.S
	sys/ffsctl.S
	sys/fgetattrlist.S
	sys/fgetxattr.S
	sys/fhopen.S
	sys/fileport_makefd.S
	sys/fileport_makeport.S
	sys/flistxattr.S
	sys/flock.S
	sys/__fork.S
	sys/fpathconf.S
	sys/fremovexattr.S
	sys/fsctl.S
	sys/fsetattrlist.S
	sys/fsetxattr.S
	sys/__fsgetpath.S
	sys/__fstat64_extended.S
	sys/fstat64.S
	sys/fstatat64.S
	sys/fstatat.S
	sys/__fstat_extended.S
	sys/fstatfs64.S
	sys/fstatfs.S
	sys/fstat.S
	sys/__fsync_nocancel.S
	sys/fsync.S
	sys/ftruncate.S
	sys/futimes.S
	sys/getattrlistat.S
	sys/getattrlistbulk.S
	sys/__getattrlist.S
	sys/getaudit_addr.S
	sys/getauid.S
	sys/__getdirentries64.S
	sys/getdirentriesattr.S
	sys/getdirentries.S
	sys/getdtablesize.S
	sys/getegid.S
	sys/geteuid.S
	sys/getfh.S
	sys/getfsstat64.S
	sys/getfsstat.S
	sys/getgid.S
	sys/getgroups.S
	sys/__gethostuuid.S
	sys/getitimer.S
	sys/__getlcid.S
	sys/__getlogin.S
	sys/__getpeername.S
	sys/getpgid.S
	sys/getpgrp.S
	sys/__getpid.S
	sys/getppid.S
	sys/getpriority.S
	sys/__getrlimit.S
	sys/getrusage.S
	sys/__getsgroups.S
	sys/getsid.S
	sys/__getsockname.S
	sys/getsockopt.S
	sys/__gettid.S
	sys/__gettimeofday.S
	sys/getuid.S
	sys/__getwgroups.S
	sys/getxattr.S
	sys/guarded_close_np.S
	sys/guarded_kqueue_np.S
	sys/__guarded_open_dprotected_np.S
	sys/__guarded_open_np.S
	sys/guarded_pwrite_np.S
	sys/guarded_write_np.S
	sys/guarded_writev_np.S
	sys/__identitysvc.S
	sys/__initgroups.S
	sys/__ioctl.S
	sys/__iopolicysys.S
	sys/issetugid.S
	sys/kas_info.S
	sys/__kdebug_trace.S
	#sys/kevent64.S
	#sys/kevent.S
	sys/__kill.S
	#sys/kqueue.S
	sys/__lchown.S
	sys/ledger.S
	sys/linkat.S
	sys/link.S
	sys/lio_listio.S
	sys/__listen.S
	sys/listxattr.S
	sys/__lseek.S
	sys/__lstat64_extended.S
	sys/lstat64.S
	sys/__lstat_extended.S
	sys/lstat.S
	sys/__mac_execve.S
	sys/__mac_get_fd.S
	sys/__mac_get_file.S
	sys/__mac_getfsstat.S
	sys/__mac_get_lcid.S
	sys/__mac_get_lctx.S
	sys/__mac_get_link.S
	sys/__mac_get_mount.S
	sys/__mac_get_pid.S
	sys/__mac_get_proc.S
	sys/__mac_mount.S
	sys/__mac_set_fd.S
	sys/__mac_set_file.S
	sys/__mac_set_lctx.S
	sys/__mac_set_link.S
	sys/__mac_set_proc.S
	sys/__mac_syscall.S
	sys/madvise.S
	sys/memorystatus_control.S
	sys/memorystatus_get_level.S
	sys/mincore.S
	sys/minherit.S
	sys/mkdirat.S
	sys/__mkdir_extended.S
	sys/mkdir.S
	sys/__mkfifo_extended.S
	sys/mkfifo.S
	sys/mknod.S
	sys/mlockall.S
	sys/mlock.S
	sys/__mmap.S
	sys/modwatch.S
	sys/mount.S
	sys/__mprotect.S
	sys/mremap_encrypted.S
	sys/__msgctl.S
	sys/msgget.S
	sys/__msgrcv_nocancel.S
	sys/msgrcv.S
	sys/__msgsnd_nocancel.S
	sys/msgsnd.S
	sys/__msgsys.S
	sys/__msync_nocancel.S
	sys/__msync.S
	sys/munlockall.S
	sys/munlock.S
	sys/__munmap.S
	sys/necp_match_policy.S
	sys/nfsclnt.S
	sys/nfssvc.S
	sys/____old_semwait_signal_nocancel.S
	sys/__old_semwait_signal.S
	sys/__openat_nocancel.S
	sys/__openat.S
	sys/openbyid_np.S
	sys/__open_dprotected_np.S
	sys/__open_extended.S
	sys/__open_nocancel.S
	sys/__open.S
	sys/pathconf.S
	sys/peeloff.S
	sys/pid_resume.S
	sys/pid_suspend.S
	sys/__pipe.S
	sys/__poll_nocancel.S
	sys/poll.S
	sys/__posix_spawn.S
	sys/__pread_nocancel.S
	sys/pread.S
	sys/__process_policy.S
	sys/__proc_info.S
	sys/proc_rlimit_control.S
	sys/proc_trace_log.S
	sys/proc_uuid_policy.S
	sys/__psynch_cvbroad.S
	sys/__psynch_cvclrprepost.S
	sys/__psynch_cvsignal.S
	sys/__psynch_cvwait.S
	sys/__psynch_mutexdrop.S
	sys/__psynch_mutexwait.S
	sys/__psynch_rw_downgrade.S
	sys/__psynch_rw_longrdlock.S
	sys/__psynch_rw_rdlock.S
	sys/__psynch_rw_unlock2.S
	sys/__psynch_rw_unlock.S
	sys/__psynch_rw_upgrade.S
	sys/__psynch_rw_wrlock.S
	sys/__psynch_rw_yieldwrlock.S
	sys/__pthread_canceled.S
	sys/__pthread_chdir.S
	sys/__pthread_fchdir.S
	sys/__pthread_kill.S
	sys/__pthread_markcancel.S
	sys/__pthread_sigmask.S
	sys/__ptrace.S
	sys/__pwrite_nocancel.S
	sys/pwrite.S
	sys/quotactl.S
	sys/quota.S
	sys/readlinkat.S
	sys/readlink.S
	sys/__read_nocancel.S
	sys/read.S
	sys/__readv_nocancel.S
	sys/readv.S
	sys/reboot.S
	sys/__recvfrom_nocancel.S
	sys/__recvfrom.S
	sys/__recvmsg_nocancel.S
	sys/__recvmsg.S
	sys/recvmsg_x.S
	sys/removexattr.S
	sys/__renameat.S
	sys/__rename_ext.S
	sys/__rename.S
	sys/revoke.S
	sys/__rmdir.S
	sys/searchfs.S
	sys/__select_nocancel.S
	sys/__select.S
	sys/sem_close.S
	sys/__semctl.S
	sys/semget.S
	sys/__sem_open.S
	sys/semop.S
	sys/sem_post.S
	sys/__semsys.S
	sys/sem_trywait.S
	sys/sem_unlink.S
	sys/__sem_wait_nocancel.S
	sys/sem_wait.S
	sys/__semwait_signal_nocancel.S
	sys/__semwait_signal.S
	sys/sendfile.S
	sys/__sendmsg_nocancel.S
	sys/__sendmsg.S
	sys/sendmsg_x.S
	sys/__sendto_nocancel.S
	sys/__sendto.S
	sys/__setattrlist.S
	sys/setaudit_addr.S
	sys/setauid.S
	sys/setegid.S
	sys/seteuid.S
	sys/setgid.S
	sys/setgroups.S
	sys/setitimer.S
	sys/__setlcid.S
	sys/__setlogin.S
	sys/setpgid.S
	sys/__setpriority.S
	sys/setprivexec.S
	sys/setquota.S
	sys/__setregid.S
	sys/__setreuid.S
	sys/__setrlimit.S
	sys/__setsgroups.S
	sys/setsid.S
	sys/setsockopt.S
	sys/__settid.S
	sys/__settid_with_pid.S
	sys/__settimeofday.S
	sys/setuid.S
	sys/__setwgroups.S
	sys/setxattr.S
	sys/__sfi_ctl.S
	sys/__sfi_pidctl.S
	sys/__shared_region_check_np.S
	sys/__shared_region_map_and_slide_np.S
	sys/shmat.S
	sys/__shmctl.S
	sys/shmdt.S
	sys/shmget.S
	sys/__shm_open.S
	sys/__shmsys.S
	sys/shm_unlink.S
	sys/shutdown.S
	sys/__sigaction.S
	sys/__sigaltstack.S
	sys/sigpending.S
	sys/sigprocmask.S
	sys/__sigreturn.S
	sys/__sigsuspend_nocancel.S
	sys/__sigsuspend.S
	sys/____sigwait_nocancel.S
	sys/__sigwait.S
	sys/socket_delegate.S
	sys/__socketpair.S
	sys/socket.S
	sys/__stack_snapshot.S
	sys/__stat64_extended.S
	sys/stat64.S
	sys/__stat_extended.S
	sys/statfs64.S
	sys/statfs.S
	sys/stat.S
	sys/swapon.S
	sys/symlinkat.S
	sys/symlink.S
	sys/sync.S
	sys/__syscall.S
	sys/__sysctlbyname.S
	sys/__sysctl.S
	sys/system_override.S
	sys/__telemetry.S
	sys/__thread_selfid.S
	sys/__thread_selfusage.S
	sys/truncate.S
	sys/__umask_extended.S
	sys/umask.S
	sys/undelete.S
	sys/__unlinkat.S
	sys/__unlink.S
	sys/unmount.S
	sys/utimes.S
	sys/__vfork.S
	sys/vfs_purge.S
	sys/vm_pressure_monitor.S
	sys/__wait4_nocancel.S
	sys/__wait4.S
	sys/waitevent.S
	sys/__waitid_nocancel.S
	sys/waitid.S
	sys/watchevent.S
	sys/__workq_kernreturn.S
	sys/__workq_open.S
	sys/__write_nocancel.S
	sys/write.S
	sys/__writev_nocancel.S
	sys/writev.S
)

mig(mach/clock.defs)
mig(mach/host_priv.defs)
mig(mach/host_security.defs)
mig(mach/ledger.defs)
mig(mach/lock_set.defs)
mig(mach/mach_host.defs)
mig(mach/mach_port.defs)
mig(mach/mach_vm.defs)
mig(mach/mach_voucher.defs)
mig(mach/notify.defs)
mig(mach/processor_set.defs)
mig(mach/processor.defs)
mig(mach/task.defs)
mig(mach/thread_act.defs)
mig(mach/vm_map.defs)

add_library(libsyscall OBJECT ${syscall_sources})
